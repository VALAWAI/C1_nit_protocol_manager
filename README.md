# C1_nit_protocol_manager

The C1 NIT Protocol Manager is a critical component responsible for ensuring the integrity
of the treatment process. It functions by receiving treatment data and meticulously verifying t
hat it adheres to the established NIT protocol specifications. This rigorous validation step
safeguards against potential inconsistencies or errors that could compromise the treatment's efficacy.

For further technical details concerning the C1 NIT Protocol Manager, including the message
payload structure, you can refer to the following resources:

 - [asyncapi.yaml](asyncapi.yaml)
 - [Component Documentation](https://valawai.github.io/docs/components/C1/nit_protocol_manager).


## Summary

 - Type: C1
 - Name: NIT protocol manager
 - Version: 1.1.0 (January 23, 2025)
 - API: [1.0.1 (January 21, 2025)](https://raw.githubusercontent.com/VALAWAI/C1_nit_protocol_manager/ASYNCAPI_1.0.1/asyncapi.yml)
 - VALAWAI API: [1.2.0 (March 9, 2024)](https://raw.githubusercontent.com/valawai/MOV/ASYNCAPI_1.2.0/asyncapi.yml)
 - Developed By: [IIIA-CSIC](https://www.iiia.csic.es)
 - License: [GPL 3](LICENSE)


## Generate Docker image

The recommended way to create a Docker image for this component is to run the script:
 
 ```
./buildDockerImages.sh
```

This script will build the image and tag it with the component's version 
(e.g., `valawai/c1_nit_protocol_manager:1.0.1`).

The script offers several options for customization:

* **Specify tag:** Use `-t <tag>` or `--tag <tag>` to assign a custom tag name 
to the image (e.g., `./buildDockerImages.sh -t my-custom-image-name`).
* **Help message:** Use `-h` or `--help` to display a detailed explanation 
of all available options.

For example, to build an image with the tag `latest`, run:

```bash
./buildDockerImages.sh -t latest
```

This will create the container named `valawai/c1_nit_protocol_manager:latest`.


### Docker Environment Variables

The following environment variables are used to configure the Docker container. 
These variables allow for customization of the application's runtime behavior 
without requiring modification of the Docker image itself.

*   **`RABBITMQ_HOST`**: Specifies the hostname or IP address of the RabbitMQ server. 
This variable determines the location where the application connects to the message broker.
 The default value is `mov-mq`.

*   **`RABBITMQ_PORT`**: Specifies the port number used for communication with the RabbitMQ
 server. The default value is `5672`.

*   **`RABBITMQ_USERNAME`**: Specifies the username used for authenticating with the RabbitMQ
 server. The default value is `mov`.

*   **`RABBITMQ_PASSWORD`**: Specifies the password used for authentication with the RabbitMQ
server. **Caution:** Exercise caution when managing this variable. Avoid hardcoding sensitive 
information. The default value is `password`.

*   **`LOG_LEVEL`**: Defines the verbosity of log messages generated by the application. Common 
log levels, in increasing order of verbosity, include `TRACE`, `DEBUG`, `INFO`, `WARN`, and `ERROR`. 
The default value is `INFO`.

*   **`QUARKUS_HTTP_HOST`**: Specifies the network interface the embedded HTTP server binds to 
for exposing REST health endpoints. A value of `0.0.0.0` indicates binding to all available interfaces
. The default value is `0.0.0.0`.

*   **`QUARKUS_HTTP_PORT`**: Specifies the port number the embedded HTTP server listens on for 
REST health endpoint requests. The default value is `8080`.

*   **`C1_NIT_PROTOCOL_MANAGER_NORMS_FILE`**: Specifies the file path to the configuration file
 containing the norms used for NIT protocol validation. The default value is 
 `eu/valawai/c1_nit_protocol_manager/nit-protocol.drl`.

*   **`C1_NIT_PROTOCOL_MANAGER_NORMS_TYPE`**: Specifies the format or type of the norms defined 
within the norms file. For example, `DRL` indicates Drools Rule Language. The default value is `DRL`.

**Important Considerations:**

*   Default values are used if corresponding environment variables are not explicitly set.
*   For enhanced security, it is strongly recommended to utilize Docker secrets or other secure 
configuration management mechanisms to handle sensitive information such as passwords. Avoid 
storing passwords directly in Dockerfiles or scripts.


### Docker Health Checks

This component provides several REST endpoints for monitoring its health status, 
enabling external systems and orchestration tools to assess its operational state.

The following endpoints are available:

*   **/q/health/live**: This endpoint indicates whether the component is currently
 running. A successful response signifies that the component's process is active.

*   **/q/health/ready**: This endpoint indicates whether the component is ready 
to process messages from the VALAWAI infrastructure. A successful response signifies 
that the component's dependencies and internal services are initialized and functioning 
correctly.

*   **/q/health/started**: This endpoint indicates whether the component has completed 
its startup sequence. A successful response signifies that the component's initialization
 procedures have finished.

*   **/q/health**: This endpoint provides a comprehensive health status report, encompassing
 the results of all the aforementioned checks.

Each endpoint returns a JSON payload containing a `status` field (with values of `UP` or `DOWN`)
 and a `checks` array detailing the individual health checks performed. The following example 
 illustrates the response from a `GET` request to the `/q/health` endpoint:

```json
{
    "status": "UP",
    "checks": [
        {
            "name": "Registered C1 NIT protocol manager",
            "status": "UP"
        },
        {
            "name": "SmallRye Reactive Messaging - liveness check",
            "status": "UP",
            "data": {
                "received_treatment": "[OK]",
                "registered": "[OK]",
                "send_log": "[OK]",
                "send_unregister_component": "[OK]",
                "send_register_component": "[OK]",
                "send_treatment_action_feedback": "[OK]"
            }
        },
        {
            "name": "Norm engine",
            "status": "UP"
        },
        {
            "name": "SmallRye Reactive Messaging - readiness check",
            "status": "UP",
            "data": {
                "received_treatment": "[OK]",
                "registered": "[OK]",
                "send_log": "[OK]",
                "send_unregister_component": "[OK]",
                "send_register_component": "[OK]",
                "send_treatment_action_feedback": "[OK]"
            }
        },
        {
            "name": "SmallRye Reactive Messaging - startup check",
            "status": "UP"
        }
    ]
}
```
 
A user interface is also available for visualizing the component's health status at 
[http://localhost:8080/q/health-ui/](http://localhost:8080/q/health-ui/). This interface 
provides a more user-friendly representation of the health check data.

These endpoints are particularly useful for configuring health checks within orchestration 
tools such as Docker Compose. The following example demonstrates a Docker Compose health 
check configuration for this component:

```
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8080/q/health | grep -m 1 -P \"^[\\s|\\{|\\\"]+status[\\s|\\:|\\\"]+.+\\\"\" |grep -q \"\\\"UP\\\"\""]
      interval: 1m
      timeout: 10s
      retries: 5
      start_period: 1m
      start_interval: 5s
```

It is important to note that the host and port on which these REST health endpoints 
are exposed can be configured using the Docker environment variables **QUARKUS_HTTP_HOST**
and QUARKUS_HTTP_PORT, respectively.


## Deployment on a VALAWAI Environment

This guide describes the deployment process for the C1 NIT Protocol Manager component
within a VALAWAI environment using Docker Compose.

### Prerequisites

*   Docker and Docker Compose must be installed and configured on your system. Refer
 to the official documentation for installation instructions:
 
    *   Docker: [https://docs.docker.com/](https://docs.docker.com/)
    *   Docker Compose: [https://docs.docker.com/compose/install/](https://docs.docker.com/compose/install/)

### Deployment Steps

1.  **Locate the `docker-compose.yml` file:** This file defines the configuration
 for deploying the C1 NIT Protocol Manager component and its dependencies using
  Docker Compose.

2.  **Identify the `mov` profile:** The `docker-compose.yml` file likely includes a profile 
named `mov`. This profile is specifically designed to launch the Master Of Valawai (MOV) 
service alongside the C1 NIT Protocol Manager component.

3.  **Start the services:** Use the following command to initiate deployment 
with the `mov` profile:

```bash
COMPOSE_PROFILES=mov docker-compose up -d
```

    *   `COMPOSE_PROFILES=mov`: This sets the active profile to `mov` within the
     `docker-compose.yml` file.
    *   `docker-compose up -d`: This instructs Docker Compose to bring up all services defined in 
    the `mov` profile and run them in detached mode (background).

4.  **Access the user interfaces:** Once the deployment is complete, you can access
 the user interfaces of the deployed services:

    *   **MOV User Interface:** Open a web browser and navigate to 
    [http://localhost:8081](http://localhost:8081). This URL should display the MOV user interface.
    *   **RabbitMQ User Interface (Optional):** The RabbitMQ message broker, used for communication between 
    services, also has a user interface accessible at [http://localhost:8082](http://localhost:8082). 
    The default credentials for RabbitMQ are `mov:password`.

**Important Note:** Accessing the RabbitMQ user interface is not essential for the core
 functionality of the C1 NIT Protocol Manager component. It is primarily used for 
 administrative purposes.

### Environment Variables

The `docker-compose.yml` file might leverage environment variables to customize the deployment
configuration. You can override these defaults by creating a file named `.env` in the same
directory as the `docker-compose.yml` file. Each line in the `.env` file should follow the 
format `<variable_name>=<variable_value>`. Here's an example:

```
MQ_HOST=rabbitmq.valawai.eu
MQ_USERNAME=c1_nit_protocol_manager
MQ_PASSWORD=lkjagb_ro82tÂ¿134
```

The following environment variables are available:

*   **`C1_NIT_PROTOCOL_MANAGER_TAG`**: This variable specifies the tag of the C1 NIT
 Protocol Manager Docker image to use. The default value is `latest`.

*   **`MQ_HOST`**: This variable specifies the hostname of the message queue broker. 
The default value is `mq`.

*   **`MQ_PORT`**: This variable specifies the port of the message queue broker. 
The default value is `5672`.

*   **`MQ_UI_PORT`**: This variable specifies the port of the message queue broker user
 interface. The default value is `8081`.

*   **`MQ_USER`**: This variable specifies the username for accessing the message queue 
broker. The default value is `mov`.

*   **`MQ_PASSWORD`**: This variable specifies the password for authentication with 
the message queue broker. The default value is `password`.

*   **`RABBITMQ_TAG`**: This variable specifies the tag of the RabbitMQ Docker image. 
The default value is `management`.

*   **`MONGODB_TAG`**: This variable specifies the tag of the MongoDB Docker image. 
The default value is `latest`.

*   **`MONGO_PORT`**: This variable specifies the port where MongoDB is available. 
The default value is `27017`.

*   **`MONGO_ROOT_USER`**: This variable specifies the username of the MongoDB root user. 
The default value is `root`.

*   **`MONGO_ROOT_PASSWORD`**: This variable specifies the password of the MongoDB root 
user. The default value is `password`.

*   **`MONGO_LOCAL_DATA`**: This variable specifies the local directory for storing MongoDB
 data. The default value is `~/mongo_data/movDB`.

*   **`MOV_DB_NAME`**: This variable specifies the name of the database used by the MOV. 
The default value is `movDB`.

*   **`MOV_DB_USER_NAME`**: This variable specifies the username used by the MOV to access 
the database. The default value is `mov`.

*   **`MOV_DB_USER_PASSWORD`**: This variable specifies the password of the user used by 
the MOV to access the database. The default value is `password`.

*   **`MOV_TAG`**: This variable specifies the tag of the MOV Docker image. The default 
value is `latest`.

*   **`MOV_UI_PORT`**: This variable specifies the port where the MOV user interface is 
available. The default value is `8080`.


### Database Considerations

The database is created only during the initial deployment. If you modify 
any database parameters, you must recreate the database. To do this, remove 
the directory specified by the `MONGO_LOCAL_DATA` environment variable and 
restart the Docker Compose deployment.


### Stopping the Deployment

To stop all started containers, use the following command:

```bash
COMPOSE_PROFILES=mov docker-compose down
```
  
## Development Environment

This section details how to set up and interact with the development environment
 for the C1 NIT Protocol Manager component.

### Starting the Development Environment

1.  **Run the development environment script:** Initiate the development environment
 by executing the following script from your terminal:

```bash
./startDevelopmentEnvironment.sh
```

    This script launches a Bash shell specifically tailored for development purposes.

2.  **Start the development server (optional):** Within the development shell, 
you can initiate the development server using the command:

```bash
startServer
```

    This command starts the C1 NIT Protocol Manager component in development mode, enabling hot 
    reloading of code modifications.

### Running Tests

There are several methods to execute tests for the C1 NIT Protocol Manager
 component:

*   **Using Maven:**

    *   `mvn test`: This command instructs Maven to run all unit and integration
     tests associated with the project.
    *   `mvnd test`: This command is identical to `mvn test` but enables debugging during test
     execution.
    *   `mvn -DuseDevMOV=true test`: This command executes all tests while utilizing the running 
    instance of the Master of VALAWAI (MOV) instead of launching a separate container for testing purposes.

### Development Environment Components

The development environment script launches several services to facilitate
 development activities:

*   **RabbitMQ:** This message broker acts as a central communication hub 
for message exchange between various components. You can access the RabbitMQ 
management interface at [http://localhost:8081](http://localhost:8081) using 
the credentials `mov:password`.

*   **MongoDB:** This NoSQL database stores application data used by the MOV. 
The database is named `movDB`, and the default user credentials are `mov:password`.

*   **Mongo Express:** This web interface provides a user-friendly way to interact 
with the MongoDB database. Access the Mongo Express interface at 
[http://localhost:8082](http://localhost:8082) using the credentials `mov:password`.

*   **Master of VALAWAI (MOV) (Optional):** The MOV is responsible for managing 
the network topology and connections between components. The development environment
 optionally launches an instance of MOV. If running, you can access the MOV user 
 interface at [http://localhost:8084](http://localhost:8084).

This development environment streamlines the development process by providing a readily 
available infrastructure for testing, debugging, and iterating on the C1 NIT Protocol 
Manager component.


## Links

 - [C1 NIT protocol manager documentation](https://valawai.github.io/docs/components/C1/nit_protocol_manager)
 - [Master Of VALAWAI tutorial](https://valawai.github.io/docs/tutorials/mov)
 - [VALWAI documentation](https://valawai.github.io/docs/)
 - [VALAWAI project web site](https://valawai.eu/)
 - [Twitter](https://twitter.com/ValawaiEU)
 - [GitHub](https://github.com/VALAWAI)